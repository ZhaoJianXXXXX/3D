<!doctype html>
<html>
	<head>
		<meta charset = 'utf-8'/>
		<title>旋转木马进阶版</title>
		<style>
			html, body{
				margin: 0;
				padding : 0;
				height : 100%;
				width : 100%;
				overflow: hidden;
			}
			body{
				display : flex;
				justify-content : center;
				align-items : center;
				perspective: 800px;
				overflow: hidden;
			}
		</style>
	</head>
	<body></body>
	<script type = 'text/javascript' src = '../../js/utils/mouse-rotate.js'></script>
	<script type = 'text/javascript' src = '../../js/utils/debounce.js'></script>
	<script type = 'text/javascript'>
		//将旋转木马作为工具类进行了封装
		function Carousel(props = {}){
			let {
				container,
				offsetY,
				offsetZ,
				imgProps,
			} = props;
			let _imgArr = [];
			let _scene = undefined;			//3d容器
			let _resize = undefined;
			//工具类初始化方法
			(function init(){
				setScene();
				setResizeFn();
			})()
			//即时适配浏览器宽高改变方法
			function setResizeFn(){
				_resize = debounce(() => this.imgRender(), 500);
				window.addEventListener('resize', _resize);
			}
			//设置3d画布
			function setScene(){
				try{
					container = container || document.body;
					_scene = document.createElement('div');
					_scene.style.position = 'relative';
					_scene.style.transformStyle = 'preserve-3d';
					_scene.style.width = '80%';
					_scene.style.height = '240px';
					_scene.style.transition = 'all .3s';
					container.appendChild(_scene)
				}catch(e){
					console.error('container is not a HTML element');
					console.error(e);
				}
			}
			/**
			 * 图片属性设置方法
			 * @parmas {array} imgArr [{ src: 'xxx' }, { src: 'yyy }]
			 */
			this.setImgArr = function(imgArr){
				_imgArr = imgArr.map((item, index) => {
					let img = new Image();
					img.src = item.src;
					img.setAttribute('index', index);			//设置img的唯一标识
					img.setAttribute('position', index);		//当前img所在的位置 从最前方开始逆时针递增(0->n)
					return new Promise(resolve => {
						img.onload = function(){
							this.height = imgProps && imgProps.height || this.height;
							this.width = imgProps && imgProps.width || this.width;
							resolve(this)
						}
					})
				});
				return this;
			}
			/**
			 * 图片列表渲染方法
			 * @parmas {array} imgArr [{ src: 'xxx' }, { src: 'yyy }]
			 */
			this.imgRender = function(){
				//清除所有子节点
				while(_scene.hasChildNodes()){ _scene.removeChild(_scene.firstChild) }
				let _this = this;
				let fatherWidth = _scene.offsetWidth;
				let singleRad = Math.PI * 2 / _imgArr.length;
				let firstPoint = { ty: offsetY, tz: offsetZ };
				Promise.all(_imgArr).then(val => val.map((img) => {
					firstPoint.tx = (fatherWidth-img.width)/2;
					let index = img.getAttribute('index');
					let rad = singleRad*index;
					let tx = firstPoint.tx-firstPoint.tx*Math.sin(rad);
					let ty = offsetY*Math.cos(rad);
					let tz = offsetZ*Math.cos(rad);
					img.style.transform = `translateX(${tx}px) translateY(${ty}px) translateZ(${tz}px)`;
					img.style.position = 'absolute';
					img.style.left = '0';
					img.style.bottom = '0';
					img.style.transition = 'all .3s';
					img.onclick = function(){
						_imgArr.map((clickImg, clickIndex) => {
							clickImg.then((clickImgNode) => {
								//找到点击的img元素(通过唯一标识index来判断)
								if(clickImgNode.getAttribute('index') === this.getAttribute('index')){
									rotateCarousel(this);
								}
							})
						})
					}
					_scene.appendChild(img);
				}));
			}
			/**
			 * 图片元素点击之后的轮转方法
			 * @parmas {imageNode} 当前img节点
			 */
			function rotateCarousel(node){
				let half = _imgArr.length/2;
				let position = Number(node.getAttribute('position'));
				//点击左半边图片
				if(position < half){
					rerenderLeft(_imgArr, position);
				}else if(position >= half){	//点击右半边图片
					rerenderRight(_imgArr, position);
				}
				/**
				 * @parmas {array} _imgArr 图片数组
				 * @parmas {number} position 点击图片的位置
				 */
				function rerenderLeft(_imgArr, position){
					if(position > 0){
						Promise.all(_imgArr).then(val => {
							let array = val.map((item) => item.style.transform);
							val.map((img, i) => {
								//数组元素中存有每img的样式，需要错位赋值(当前元素按照position与前一个元素交换)
								let index = i === 0 ? array.length-1 : i-1;
								//position的替换 不能用index 需要使用img当前position-1 并考虑边界值的情况
								let imgPos = Number(img.getAttribute('position'));
								imgPos = imgPos < 1 ? array.length-1 : imgPos-1;
								img.style.transform = array[index];
								img.setAttribute('position', imgPos);
							})
							position -= 1;
							let t = setTimeout(() => {
								clearTimeout(t);
								rerenderLeft(_imgArr, position);
							}, 300);
						})
					}
				}
				/**
				 * @parmas {array} _imgArr 图片数组
				 * @parmas {number} position 点击图片的位置
				 */
				function rerenderRight(_imgArr, position){
					if(position < _imgArr.length && position !== 0){
						Promise.all(_imgArr).then(val => {
							let array = val.map((item) => item.style.transform);
							val.map((img, i) => {
								//数组元素中存有每img的样式，需要错位赋值(当前元素按照position与后一个元素交换)
								let index = i >= array.length-1 ? 0 : i+1;
								//position的替换 不能用index 需要使用img当前position-1 并考虑边界值的情况
								let imgPos = Number(img.getAttribute('position'));
								imgPos = imgPos >= array.length-1 ? 0 : imgPos+1;
								img.style.transform = array[index];
								img.setAttribute('position', imgPos);
							})
							position = position >= _imgArr.length-1 ? 0 : position+1;
							let t = setTimeout(() => {
								clearTimeout(t);
								rerenderRight(_imgArr, position);
							}, 300);
						})
					}
				}
			}

			this.destory = function(){
				_imgArr = [];
				window.removeEventListener('resize', _resize);
				this.imgRender();
				return this;
			}

			this.scene = _scene;
		}
	</script>
	<script type = 'text/javascript'>
//		let imgArray = new Array(6).fill().map(() => ({ src: './image/ride.gif' }))
		let imgArray = new Array(12).fill().map(() => {
//			let num = Math.random() * 9 + 1;
//			let src = num > 5 ? '../../image/ride.gif' : '../../image/card.jpg';
//			let src = '../../image/ride.gif';
			let src = '../../image/card1.png';
			return { src };
		})
		let fatherNode = document.getElementById('carousel');
		let carousel = new Carousel({
			container: document.body,
			offsetY: 150,
			offsetZ: 200,
			imgProps : { width: 240, height: 180 }
		});
		carousel.setImgArr(imgArray).imgRender();
		carousel.scene.addEventListener('mousedown', window.mouseRotate.bind(carousel.scene));
	</script>
</html>
